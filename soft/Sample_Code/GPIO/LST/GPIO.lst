C51 COMPILER V9.56.0.0   GPIO                                                              03/15/2020 14:53:36 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE GPIO
OBJECT MODULE PLACED IN .\Output\GPIO.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Code\GPIO.C OPTIMIZE(8,SPEED) BROWSE INCDIR(..\..\Include) DEFINE(FOSC_1
                    -60000) DEBUG OBJECTEXTEND PRINT(.\LST\GPIO.lst) OBJECT(.\Output\GPIO.obj)

line level    source

   1          #include "N76E003.h"
   2          #include "SFR_Macro.h"
   3          #include "Function_define.h"
   4          #include "Common.h"
   5          #include "Delay.h"
   6          #include <string.h>
   7          // #include "keyScanCode.h"
   8          #include "keyMap.h"
   9          
  10          // #define row1 P00
  11          // #define row2 P01
  12          // #define row3 P02
  13          // #define row4 P03
  14          // #define row5 P04
  15          
  16          // #define col1 P10
  17          // #define col2 P11
  18          // #define col3 P12
  19          // #define col4 P13
  20          // #define col5 P14
  21          // #define col6 P15
  22          // #define col7 P16
  23          // #define col8 P17
  24          
  25          unsigned int i, j;
  26          unsigned char xdata beforeAllKey[5]; // 40个位，保存上一次所有40个建的状态
  27          unsigned char xdata allKey[5];           // 40个位，保存当前所有40个建的状态
  28          
  29          unsigned int kCode;
  30          unsigned char xdata HIDFrames[8];
  31          unsigned int HIDFramesPointer = 2;
  32          
  33          UINT8 tttt = 0;
  34          UINT16 TH1_INIT = 333;
  35          
  36          void makeHIDFrames(void)
  37          {
  38   1              HIDFramesPointer = 2;
  39   1              for (i = 0; i < 8; i++)
  40   1              {
  41   2                      HIDFrames[i] = 0;
  42   2              }
  43   1              if (allKey[0] == 0 && allKey[1] == 0 && allKey[2] == 0 && allKey[3] == 0 && allKey[4] == 0)
  44   1              {
  45   2                      for (i = 0; i < 8; i++)
  46   2                      {
  47   3                              Send_Data_To_UART0(0x00);
  48   3                      }
  49   2              }
  50   1              else
  51   1              {
  52   2                      for (i = 0; i < 5; i++)
  53   2                      {
  54   3                              if (allKey[i] != 0)
C51 COMPILER V9.56.0.0   GPIO                                                              03/15/2020 14:53:36 PAGE 2   

  55   3                              {
  56   4                                      for (j = 0; j < 8; j++)
  57   4                                      {
  58   5                                              if (allKey[i] >> j & 1)
  59   5                                              {
  60   6                                                      kCode = keyMap[i * 8 + j];
  61   6                                                      // if (kCode == KEY_LCTRL | kCode == KEY_LSHIFT | kCode == KEY_LALT | kCode == KEY_LGUI | kCode == K
             -EY_RCTRL | kCode == KEY_RSHIFT | kCode == KEY_RALT | kCode == KEY_RGUI)
  62   6                                                      if (kCode >= 0xE0)
  63   6                                                      {
  64   7                                                              HIDFrames[0] += 0X01 << (kCode & 0X0F);
  65   7                                                      }
  66   6                                                      else
  67   6                                                      {
  68   7                                                              HIDFrames[HIDFramesPointer] = kCode;
  69   7                                                              HIDFramesPointer++;
  70   7                                                      }
  71   6                                              }
  72   5                                      }
  73   4                              }
  74   3                      }
  75   2                      for (i = 0; i < 8; i++)
  76   2                      {
  77   3                              Send_Data_To_UART0(HIDFrames[i]);
  78   3                      }
  79   2              }
  80   1      }
  81          
  82          // 系统时钟      16000 / 16000000 = 0.001s
  83          // 系统时钟1/12  1333  / 1333333  = 0.001s
  84          void Timer1_ISR(void) interrupt 3 //interrupt address is 0x001B
  85          {
  86   1              TH1 = (65536 - TH1_INIT) / 256;
  87   1              TL1 = (65536 - TH1_INIT) % 256;
  88   1      
  89   1              // row1到row5依次拉低
  90   1              P0 = 0xFF;
  91   1              if (tttt == 5) //所有键扫描完成
  92   1              {
  93   2                      tttt = 0;
  94   2                      if (memcmp(beforeAllKey, allKey, 5) != 0)
  95   2                      {
  96   3                              memcpy(beforeAllKey, allKey, 5);
  97   3      
  98   3                              makeHIDFrames();
  99   3                              // Send_Data_To_UART0(allKey[i]);
 100   3                      }
 101   2              }
 102   1              else
 103   1              {
 104   2                      if (tttt == 0)
 105   2                              P00 = 0;
 106   2                      if (tttt == 1)
 107   2                              P01 = 0;
 108   2                      if (tttt == 2)
 109   2                              P02 = 0;
 110   2                      if (tttt == 3)
 111   2                              P03 = 0;
 112   2                      if (tttt == 4)
 113   2                              P04 = 0;
 114   2      
 115   2                      allKey[tttt] = ~P1;
C51 COMPILER V9.56.0.0   GPIO                                                              03/15/2020 14:53:36 PAGE 3   

 116   2      
 117   2                      tttt++;
 118   2              }
 119   1      }
 120          
 121          void main(void)
 122          {
 123   1              ///////////////////////////////////WDT///////////////////////////////////////
 124   1              TA = 0xAA;
 125   1              TA = 0x55;
 126   1              WDCON = 0x07; //Setting WDT prescale
 127   1              set_WDTR;        //WDT run
 128   1              set_WDCLR;      //Clear WDT timer
 129   1              set_EWDT;
 130   1              EA = 1;
 131   1              //set_WIDPD;
 132   1              /////////////////////////////////////////////////////////////////////////////
 133   1      
 134   1              Set_All_GPIO_Quasi_Mode;
 135   1      
 136   1              P00_PushPull_Mode;
 137   1              P01_PushPull_Mode;
 138   1              P02_PushPull_Mode;
 139   1              P03_PushPull_Mode;
 140   1              P04_PushPull_Mode;
 141   1      
 142   1              TIMER1_MODE1_ENABLE;
 143   1              // set_T1M;
 144   1              TH1 = (65536 - TH1_INIT) / 256;
 145   1              TL1 = (65536 - TH1_INIT) % 256;
 146   1              set_ET1; //enable Timer1 interrupt
 147   1              set_EA;  //enable interrupts
 148   1              set_TR1; //Timer1 run
 149   1      
 150   1              InitialUART0_Timer3(115200);
 151   1              // Enable_ADC_AIN1; // Enable AIN0 as ADC input, Find in "Function_define.h" - "ADC INIT"
 152   1              // Enable_ADC_AIN7;
 153   1      
 154   1              while (1)
 155   1              {
 156   2                      set_WDCLR; // 喂狗
 157   2              }
 158   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    732    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     18    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     51    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
